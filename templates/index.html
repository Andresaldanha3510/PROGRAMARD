<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de RDs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fonte e FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" referrerpolicy="no-referrer" />
  <!-- Estilos do DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css" />
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #f39c12;
      --success-color: #2ecc71;
      --danger-color: #e74c3c;
      --warning-color: #f1c40f;
      --background-color: #f2f3f5;
      --header-color: #34495e;
      --text-color: #2c3e50;
      --footer-background: #2c3e50;
      --footer-text: #ecf0f1;
      --border-color: #dddddd;
      --input-border: #dcdde1;
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    .btn i { margin-right: 5px; }
    .top-bar {
      background: var(--header-color);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
    }
    .top-bar .user-info { font-weight: 600; }
    .top-bar a {
      color: #fff;
      margin-left: 10px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
    }
    .top-bar a:hover { text-decoration: underline; }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h1, h2 { text-align: center; margin: 20px 0; font-weight: 700; }
    .main-form {
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      background: #fff;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    }
    .main-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--header-color);
    }
    .main-form input, .main-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid var(--input-border);
      border-radius: 5px;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    .main-form button {
      background-color: var(--primary-color);
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
    }
    .main-form button:hover { background-color: #2980b9; }
    button, .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-primary { background-color: var(--primary-color); color: #fff; }
    .btn-secondary { background-color: var(--secondary-color); color: #fff; }
    .btn-success { background-color: var(--success-color); color: #fff; }
    .btn-danger { background-color: var(--danger-color); color: #fff; }
    .btn-warning { background-color: var(--warning-color); color: #34495e; }
    .btn-approve { background-color: var(--success-color); color: #fff; }
    .btn-additional { background-color: var(--secondary-color); color: #fff; }
    .btn-fechamento { background-color: #8e44ad; color: #fff; }
    .btn-delete-rd {
      background-color: var(--danger-color);
      padding: 8px 18px;
      font-size: 0.75rem;
      color: #fff;
    }
    .btn-delete-file {
      background-color: var(--danger-color);
      padding: 2px 6px;
      font-size: 0.7rem;
      border-radius: 50%;
      height: 20px;
      width: 20px;
      margin-left: 5px;
    }
    .btn-edit {
      background-color: #f1c40f;
      color: #34495e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid var(--border-color);
      vertical-align: middle;
    }
    th {
      background-color: var(--primary-color);
      color: #fff;
      font-weight: 600;
    }
    tr:hover { background-color: #f9f9f9; }
    @media (max-width:768px){
      table, thead, tbody, th, td, tr { display: block; }
      th { position: absolute; top: -9999px; left: -9999px; }
      tr { margin-bottom: 15px; }
      td {
        border: none;
        position: relative;
        padding-left: 50%;
        white-space: pre-wrap;
        border-bottom: 1px solid var(--border-color);
      }
      td::before {
        content: attr(data-label);
        position: absolute;
        left: 15px;
        font-weight: 600;
      }
      .btn, .btn-delete-rd { width: 100%; margin-bottom: 10px; }
    }
    .arquivo-link {
      text-decoration: none;
      color: var(--primary-color);
      font-size: 0.9rem;
      margin-right: 10px;
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .arquivo-link:hover { text-decoration: underline; }
    .error-message {
      color: var(--danger-color);
      font-size: 0.85rem;
      margin-bottom: 15px;
      list-style: none;
    }
    footer {
      text-align: center;
      color: var(--footer-text);
      font-size: 0.85rem;
      padding: 10px 0;
      background-color: var(--footer-background);
      position: fixed;
      width: 100%;
      bottom: 0;
    }
    .tabs { margin-top: 20px; }
    .tabs input[type="radio"] { display: none; }
    .tab-labels {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 5px;
    }
    .tab-labels label {
      background-color: #ecf0f1;
      padding: 8px 15px;
      margin: 2px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .tab-labels label:hover { background-color: #ddd; }
    .tab-content { display: none; }
    input[type="radio"]:checked + label {
      background-color: var(--primary-color);
      color: #fff;
    }
    /* Definindo as abas com base no papel do usuário */
    {% if user_role == 'supervisor' %}
      <input type="radio" name="tab-control" id="tab1">
      <input type="radio" name="tab-control" id="tab2">
      <input type="radio" name="tab-control" id="tab3" checked>
      <input type="radio" name="tab-control" id="tab4">
      <input type="radio" name="tab-control" id="tab5">
      <input type="radio" name="tab-control" id="tab6">
      <input type="radio" name="tab-control" id="tab7">
    {% else %}
      <input type="radio" name="tab-control" id="tab1" checked>
      <input type="radio" name="tab-control" id="tab2">
      <input type="radio" name="tab-control" id="tab3">
      <input type="radio" name="tab-control" id="tab4">
      <input type="radio" name="tab-control" id="tab5">
      <input type="radio" name="tab-control" id="tab6">
    {% endif %}

    <div class="tab-labels">
      <label for="tab1">Pendentes {% if pendentes|length > 0 %}<span class="badge">{{ pendentes|length }}</span>{% endif %}</label>
      <label for="tab2">Aprovados {% if aprovados|length > 0 %}<span class="badge">{{ aprovados|length }}</span>{% endif %}</label>
      <label for="tab3">Liberados {% if liberados|length > 0 %}<span class="badge">{{ liberados|length }}</span>{% endif %}</label>
      <label for="tab4">Fechamento Solicitado {% if fechamento_solicitado|length > 0 %}<span class="badge">{{ fechamento_solicitado|length }}</span>{% endif %}</label>
      <label for="tab5">Fechamento Recusado {% if fechamento_recusado|length > 0 %}<span class="badge">{{ fechamento_recusado|length }}</span>{% endif %}</label>
      <label for="tab6">Fechados {% if fechados|length > 0 %}<span class="badge">{{ fechados|length }}</span>{% endif %}</label>
      {% if user_role == 'supervisor' %}
        <label for="tab7">Divergências {% if divergentes and divergentes|length > 0 %}<span class="badge">{{ divergentes|length }}</span>{% endif %}</label>
      {% endif %}
    </div>

    <div class="content">
      <!-- Aba Pendentes -->
      <div class="tab-content" id="content1">
        <table id="tabela-pendentes" class="display">
          <thead>
            <tr>
              <th>ID</th>
              <th>Solicitante</th>
              <th>Funcionário</th>
              <th>Data</th>
              <th>Centro de Custo</th>
              <th>Observação</th>
              <th>Arquivos</th>
              <th>Valores</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for rd in pendentes %}
              {% set rd_id = rd[0] %}
              {% set status = rd[6] %}
              <tr>
                <td data-label="ID">{{ rd_id }}<br><small>({{ rd[17] }})</small></td>
                <td data-label="Solicitante">{{ rd[1] }}</td>
                <td data-label="Funcionário">{{ rd[2] }}</td>
                <td data-label="Data">{{ rd[3] }}</td>
                <td data-label="Centro de Custo">{{ rd[4] }}<br><small>{{ rd[19] }}</small></td>
                <td data-label="Observação">
                  {% if rd[16] %}
                    {% set obs = rd[16] %}
                    {% if obs|length > 50 %}
                      <span class="observation-short">{{ obs[:50] }}...</span>
                      <button class="toggle-observation" onclick="toggleObservation(this)">+</button>
                      <div class="observation-full">{{ obs }}</div>
                    {% else %}
                      {{ obs }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Arquivos">
                  {% if rd[12] %}
                    <button class="btn btn-secondary btn-view-files" data-files="{{ rd[12] }}" data-rd-id="{{ rd[0] }}">
                      <i class="fas fa-paperclip"></i> Anexos
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Valores">{{ mostrar_valores(rd) }}</td>
                <td data-label="Ações">
                  {% if can_approve_func(status) %}
                    <form action="/approve/{{ rd_id }}" method="POST" class="action-form">
                      <button type="submit" class="btn btn-approve"><i class="fas fa-check"></i> Aprovar</button>
                    </form>
                  {% endif %}
                  {% if can_edit_func(status) %}
                    <a href="{{ url_for('edit_form', id=rd_id) }}" class="btn btn-edit"><i class="fas fa-edit"></i> Editar</a>
                  {% endif %}
                  {% if can_delete_func(status, rd[1]) %}
                    <form action="/delete/{{ rd_id }}" method="POST" class="action-form">
                      <button type="submit" class="btn btn-delete-rd"><i class="fas fa-trash-alt"></i> Excluir</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Aba Aprovados -->
      <div class="tab-content" id="content2">
        <table id="tabela-aprovados" class="display">
          <thead>
            <tr>
              <th>ID</th>
              <th>Solicitante</th>
              <th>Funcionário</th>
              <th>Data</th>
              <th>Centro de Custo</th>
              <th>Observação</th>
              <th>Arquivos</th>
              <th>Valores</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for rd in aprovados %}
              {% set rd_id = rd[0] %}
              {% set status = rd[6] %}
              <tr>
                <td data-label="ID">{{ rd_id }}<br><small>({{ rd[17] }})</small></td>
                <td data-label="Solicitante">{{ rd[1] }}</td>
                <td data-label="Funcionário">{{ rd[2] }}</td>
                <td data-label="Data">{{ rd[3] }}</td>
                <td data-label="Centro de Custo">{{ rd[4] }}</td>
                <td data-label="Observação">
                  {% if rd[16] %}
                    {% set obs = rd[16] %}
                    {% if obs|length > 50 %}
                      <span class="observation-short">{{ obs[:50] }}...</span>
                      <button class="toggle-observation" onclick="toggleObservation(this)">+</button>
                      <div class="observation-full">{{ obs }}</div>
                    {% else %}
                      {{ obs }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Arquivos">
                  {% if rd[12] %}
                    <button class="btn btn-secondary btn-view-files" data-files="{{ rd[12] }}" data-rd-id="{{ rd[0] }}">
                      <i class="fas fa-paperclip"></i> Anexos
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Valores">{{ mostrar_valores(rd) }}</td>
                <td data-label="Ações">
                  {% if can_approve_func(status) %}
                    <form action="/approve/{{ rd_id }}" method="POST" class="action-form">
                      <button type="submit" class="btn btn-approve"><i class="fas fa-check"></i> Liberar</button>
                    </form>
                  {% endif %}
                  {% if can_edit_func(status) %}
                    <a href="{{ url_for('edit_form', id=rd_id) }}" class="btn btn-edit"><i class="fas fa-edit"></i> Editar</a>
                  {% endif %}
                  {% if can_delete_func(status, rd[1]) %}
                    <form action="/delete/{{ rd_id }}" method="POST" class="action-form">
                      <button type="submit" class="btn btn-delete-rd"><i class="fas fa-trash-alt"></i> Excluir</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Aba Liberados -->
      <div class="tab-content" id="content3">
        <table id="tabela-liberados" class="display">
          <thead>
            <tr>
              <th>ID</th>
              <th>Solicitante</th>
              <th>Funcionário</th>
              <th>Data</th>
              <th>Centro de Custo</th>
              <th>Observação</th>
              <th>Arquivos</th>
              <th>Valores</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for rd in liberados %}
              {% set rd_id = rd[0] %}
              {% set status = rd[6] %}
              <tr>
                <td data-label="ID">{{ rd_id }}<br><small>({{ rd[17] }})</small></td>
                <td data-label="Solicitante">{{ rd[1] }}</td>
                <td data-label="Funcionário">{{ rd[2] }}</td>
                <td data-label="Data">{{ rd[3] }}</td>
                <td data-label="Centro de Custo">{{ rd[4] }}</td>
                <td data-label="Observação">
                  {% if rd[16] %}
                    {% set obs = rd[16] %}
                    {% if obs|length > 50 %}
                      <span class="observation-short">{{ obs[:50] }}...</span>
                      <button class="toggle-observation" onclick="toggleObservation(this)">+</button>
                      <div class="observation-full">{{ obs }}</div>
                    {% else %}
                      {{ obs }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Arquivos">
                  {% if rd[12] %}
                    <button class="btn btn-secondary btn-view-files" data-files="{{ rd[12] }}" data-rd-id="{{ rd_id }}">
                      <i class="fas fa-paperclip"></i> Anexos
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Valores">{{ mostrar_valores(rd) }}</td>
                <td data-label="Ações">
                  {% if can_edit_func(status) %}
                    <a href="{{ url_for('edit_form', id=rd_id) }}" class="btn btn-edit"><i class="fas fa-edit"></i> Editar</a>
                  {% endif %}
                  {% if can_delete_func(status, rd[1]) %}
                    <form action="/delete/{{ rd_id }}" method="POST" class="action-form">
                      <button type="submit" class="btn btn-delete-rd"><i class="fas fa-trash-alt"></i> Excluir</button>
                    </form>
                  {% endif %}
                  {% if can_request_additional(status) %}
                    <form action="/" method="GET" class="action-form">
                      <input type="hidden" name="adicional" value="{{ rd_id }}">
                      <button type="submit" class="btn btn-additional"><i class="fas fa-plus"></i> Adicional</button>
                    </form>
                  {% endif %}
                  {% if can_close(status) %}
                    <form action="/" method="GET" class="action-form">
                      <input type="hidden" name="fechamento" value="{{ rd_id }}">
                      <button type="submit" class="btn btn-fechamento"><i class="fas fa-lock"></i> Fechamento</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Aba Fechamento Solicitado -->
      <div class="tab-content" id="content4">
        <table id="tabela-fechamento-solicitado" class="display">
          <thead>
            <tr>
              <th>ID</th>
              <th>Solicitante</th>
              <th>Funcionário</th>
              <th>Data</th>
              <th>Centro de Custo</th>
              <th>Observação</th>
              <th>Arquivos</th>
              <th>Valores</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for rd in fechamento_solicitado %}
              {% set rd_id = rd[0] %}
              {% set status = rd[6] %}
              <tr>
                <td data-label="ID">{{ rd_id }}<br><small>({{ rd[17] }})</small></td>
                <td data-label="Solicitante">{{ rd[1] }}</td>
                <td data-label="Funcionário">{{ rd[2] }}</td>
                <td data-label="Data">{{ rd[3] }}</td>
                <td data-label="Centro de Custo">{{ rd[4] }}</td>
                <td data-label="Observação">
                  {% if rd[16] %}
                    {% set obs = rd[16] %}
                    {% if obs|length > 50 %}
                      <span class="observation-short">{{ obs[:50] }}...</span>
                      <button class="toggle-observation" onclick="toggleObservation(this)">+</button>
                      <div class="observation-full">{{ obs }}</div>
                    {% else %}
                      {{ obs }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Arquivos">
                  {% if rd[12] %}
                    <button class="btn btn-secondary btn-view-files" data-files="{{ rd[12] }}" data-rd-id="{{ rd[0] }}">
                      <i class="fas fa-paperclip"></i> Anexos
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Valores">{{ mostrar_valores(rd) }}</td>
                <td data-label="Ações">
                  {% if can_approve_func(status) %}
                    <form action="/approve/{{ rd_id }}" method="POST" class="action-form" style="display:inline-block;">
                      <button type="submit" class="btn btn-approve"><i class="fas fa-check"></i> Fechar</button>
                    </form>
                  {% endif %}
                  {% if is_gestor() and status == 'Fechamento Solicitado' %}
                    <button type="button" class="btn btn-danger btn-recusar" data-rd-id="{{ rd_id }}">
                      <i class="fas fa-times"></i> Recusar
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Aba Fechamento Recusado -->
      <div class="tab-content" id="content5">
        <table id="tabela-fechamento-recusado" class="display">
          <thead>
            <tr>
              <th>ID</th>
              <th>Solicitante</th>
              <th>Funcionário</th>
              <th>Data</th>
              <th>Centro de Custo</th>
              <th>Observação</th>
              <th>Motivo da Recusa</th>
              <th>Arquivos</th>
              <th>Valores</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for rd in fechamento_recusado %}
              {% set rd_id = rd[0] %}
              <tr>
                <td data-label="ID">{{ rd_id }}<br><small>({{ rd[17] }})</small></td>
                <td data-label="Solicitante">{{ rd[1] }}</td>
                <td data-label="Funcionário">{{ rd[2] }}</td>
                <td data-label="Data">{{ rd[3] }}</td>
                <td data-label="Centro de Custo">{{ rd[4] }}</td>
                <td data-label="Observação">
                  {% if rd[16] %}
                    {% set obs = rd[16] %}
                    {% if obs|length > 50 %}
                      <span class="observation-short">{{ obs[:50] }}...</span>
                      <button class="toggle-observation" onclick="toggleObservation(this)">+</button>
                      <div class="observation-full">{{ obs }}</div>
                    {% else %}
                      {{ obs }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Motivo da Recusa">{{ rd[20] }}</td>
                <td data-label="Arquivos">
                  {% if rd[12] %}
                    <button class="btn btn-secondary btn-view-files" data-files="{{ rd[12] }}" data-rd-id="{{ rd[0] }}">
                      <i class="fas fa-paperclip"></i> Anexos
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Valores">{{ mostrar_valores(rd) }}</td>
                <td data-label="Ações">
                  {% if is_solicitante() %}
                    <a href="{{ url_for('edit_form', id=rd_id) }}" class="btn btn-edit">
                      <i class="fas fa-edit"></i> Corrigir e reenviar
                    </a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Aba Fechados -->
      <div class="tab-content" id="content6">
        <table id="tabela-fechados" class="display">
          <thead>
            <tr>
              <th>ID</th>
              <th>Solicitante</th>
              <th>Funcionário</th>
              <th>Data</th>
              <th>Centro de Custo</th>
              <th>Observação</th>
              <th>Arquivos</th>
              <th>Valores</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for rd in fechados %}
              {% set rd_id = rd[0] %}
              <tr>
                <td data-label="ID">{{ rd_id }}<br><small>({{ rd[17] }})</small></td>
                <td data-label="Solicitante">{{ rd[1] }}</td>
                <td data-label="Funcionário">{{ rd[2] }}</td>
                <td data-label="Data">{{ rd[3] }}</td>
                <td data-label="Centro de Custo">{{ rd[4] }}</td>
                <td data-label="Observação">
                  {% if rd[16] %}
                    {% set obs = rd[16] %}
                    {% if obs|length > 50 %}
                      <span class="observation-short">{{ obs[:50] }}...</span>
                      <button class="toggle-observation" onclick="toggleObservation(this)">+</button>
                      <div class="observation-full">{{ obs }}</div>
                    {% else %}
                      {{ obs }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Arquivos">
                  {% if rd[12] %}
                    <button class="btn btn-secondary btn-view-files" data-files="{{ rd[12] }}" data-rd-id="{{ rd[0] }}">
                      <i class="fas fa-paperclip"></i> Anexos
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Valores">{{ mostrar_valores(rd) }}</td>
                <td data-label="Ações">
                  {% if is_financeiro() %}
                    {% if not rd[18] %}
                      <form action="/registrar_saldo_devolvido/{{ rd_id }}" method="POST" class="action-form">
                        <button type="submit" class="btn btn-warning">
                          <i class="fas fa-money-bill-wave"></i> Saldo Devolvido
                        </button>
                      </form>
                    {% else %}
                      <span style="color: var(--success-color); font-weight:600;">Devolvido</span>
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if user_role == 'supervisor' %}
      <!-- Nova Aba Divergências para o Supervisor -->
      <div class="tab-content" id="content7">
        <table id="tabela-divergentes" class="display">
          <thead>
            <tr>
              <th>ID</th>
              <th>Solicitante</th>
              <th>Funcionário</th>
              <th>Data</th>
              <th>Centro de Custo</th>
              <th>Observação</th>
              <th>Arquivos</th>
              <th>Valores</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for rd in divergentes %}
              {% set rd_id = rd[0] %}
              {% set status = rd[6] %}
              <tr>
                <td data-label="ID">{{ rd_id }}<br><small>({{ rd[17] }})</small></td>
                <td data-label="Solicitante">{{ rd[1] }}</td>
                <td data-label="Funcionário">{{ rd[2] }}</td>
                <td data-label="Data">{{ rd[3] }}</td>
                <td data-label="Centro de Custo">{{ rd[4] }}</td>
                <td data-label="Observação">
                  {% if rd[16] %}
                    {% set obs = rd[16] %}
                    {% if obs|length > 50 %}
                      <span class="observation-short">{{ obs[:50] }}...</span>
                      <button class="toggle-observation" onclick="toggleObservation(this)">+</button>
                      <div class="observation-full">{{ obs }}</div>
                    {% else %}
                      {{ obs }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Arquivos">
                  {% if rd[12] %}
                    <button class="btn btn-secondary btn-view-files" data-files="{{ rd[12] }}" data-rd-id="{{ rd_id }}">
                      <i class="fas fa-paperclip"></i> Anexos
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Valores">{{ mostrar_valores(rd) }}</td>
                <td data-label="Ações">
                  <form action="{{ url_for('corrigir_divergencia', id=rd_id) }}" method="POST">
                    <button type="submit" class="btn btn-success">
                      <i class="fas fa-check"></i> Corrigir (Remover Divergência)
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal para exibir anexos -->
<div id="fileModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeFileModal">&times;</span>
    <h3>Arquivos Anexados</h3>
    <div id="modalFilesContainer"></div>
  </div>
</div>

<!-- Modal para recusa do fechamento -->
<div id="recusaModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeRecusaModal">&times;</span>
    <h3>Informe o Motivo da Recusa</h3>
    <form id="formRecusa" method="POST">
      <textarea name="motivo" id="motivo" rows="4" style="width:100%;" placeholder="Digite o motivo..."></textarea>
      <br>
      <button type="submit" class="btn btn-danger">Enviar Recusa</button>
    </form>
  </div>
</div>

<!-- Modal para divergência de anexos -->
<div id="divergenciaModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeDivergenciaModal">&times;</span>
    <h3>Informe o Motivo da Divergência</h3>
    <form id="formDivergencia" method="POST">
      <textarea name="motivo_divergencia" id="motivo_divergencia" rows="4" style="width:100%;" placeholder="Explique a divergência..."></textarea>
      <br>
      <button type="submit" class="btn btn-divergencia">Enviar Divergência</button>
    </form>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<script>
  // Mostra/esconde form de RD Alelo/Reembolso
  const btnAlelo = document.getElementById('btn-alelo');
  const btnReembolso = document.getElementById('btn-reembolso');
  const formSolicitacao = document.getElementById('form-solicitacao');
  const rdTipo = document.getElementById('rd-tipo');

  if(btnAlelo) {
    btnAlelo.addEventListener('click', () => {
      formSolicitacao.style.display = 'block';
      rdTipo.value = 'credito alelo';
      document.getElementById('lbl-solicitante').textContent = 'Solicitante (Alelo):';
    });
  }
  if(btnReembolso) {
    btnReembolso.addEventListener('click', () => {
      formSolicitacao.style.display = 'block';
      rdTipo.value = 'reembolso';
      document.getElementById('lbl-solicitante').textContent = 'Solicitante (Reembolso):';
    });
  }

  // DataTables
  $(document).ready(function() {
    $('#tabela-pendentes').DataTable();
    $('#tabela-aprovados').DataTable();
    $('#tabela-liberados').DataTable();
    $('#tabela-divergentes').DataTable();
    $('#tabela-fechamento-solicitado').DataTable();
    $('#tabela-fechamento-recusado').DataTable();
    $('#tabela-fechados').DataTable();
  });

  // Toggle observação
  function toggleObservation(btn) {
    const obsFull = btn.parentNode.querySelector('.observation-full');
    if(obsFull.style.display === 'none' || obsFull.style.display === '') {
      obsFull.style.display = 'block';
      btn.textContent = '-';
    } else {
      obsFull.style.display = 'none';
      btn.textContent = '+';
    }
  }

  // Toggle detalhes dos valores
  document.querySelectorAll('.toggle-details').forEach(button => {
    button.addEventListener('click', () => {
      const details = button.parentNode.nextElementSibling;
      if(details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
        button.textContent = '-';
      } else {
        details.style.display = 'none';
        button.textContent = '+';
      }
    });
  });

  // Modal de anexos
  const fileModal = document.getElementById('fileModal');
  const closeFileModal = document.getElementById('closeFileModal');
  const modalFilesContainer = document.getElementById('modalFilesContainer');

  document.querySelectorAll('.btn-view-files').forEach(btn => {
    btn.addEventListener('click', () => {
      const files = btn.getAttribute('data-files');
      const rdId = btn.getAttribute('data-rd-id');
      modalFilesContainer.innerHTML = '';
      if(!files) {
        modalFilesContainer.innerHTML = '<p>Nenhum arquivo anexo.</p>';
      } else {
        const arrFiles = files.split(',');
        arrFiles.forEach(f => {
          const fileDiv = document.createElement('div');
          fileDiv.classList.add('file-item');
          const link = document.createElement('a');
          link.href = "{{ get_r2_public_url('') }}" + f;
          link.target = '_blank';
          link.classList.add('arquivo-link');
          link.innerText = f;
          fileDiv.appendChild(link);

          // Botão excluir
          const formDelete = document.createElement('form');
          formDelete.method = 'POST';
          formDelete.action = '/delete_file/' + rdId;
          formDelete.style.display = 'inline-block';
          const inputHidden = document.createElement('input');
          inputHidden.type = 'hidden';
          inputHidden.name = 'filename';
          inputHidden.value = f;
          formDelete.appendChild(inputHidden);

          const btnDelete = document.createElement('button');
          btnDelete.type = 'submit';
          btnDelete.classList.add('btn-delete-file');
          btnDelete.innerHTML = '<i class="fas fa-trash"></i>';
          formDelete.appendChild(btnDelete);

          fileDiv.appendChild(formDelete);
          modalFilesContainer.appendChild(fileDiv);
        });
      }
      fileModal.style.display = 'block';
    });
  });

  closeFileModal.addEventListener('click', () => {
    fileModal.style.display = 'none';
  });

  // Modal de recusa do fechamento
  const recusaModal = document.getElementById('recusaModal');
  const closeRecusaModal = document.getElementById('closeRecusaModal');
  const formRecusa = document.getElementById('formRecusa');

  document.querySelectorAll('.btn-recusar').forEach(btn => {
    btn.addEventListener('click', () => {
      const rdId = btn.getAttribute('data-rd-id');
      formRecusa.action = '/reject_fechamento/' + rdId;
      recusaModal.style.display = 'block';
    });
  });
  closeRecusaModal.addEventListener('click', () => {
    recusaModal.style.display = 'none';
  });

  // Modal de divergência
  const divergenciaModal = document.getElementById('divergenciaModal');
  const closeDivergenciaModal = document.getElementById('closeDivergenciaModal');
  const formDivergencia = document.getElementById('formDivergencia');

  document.querySelectorAll('.btn-divergencia').forEach(btn => {
    btn.addEventListener('click', () => {
      const rdId = btn.getAttribute('data-rd-id');
      formDivergencia.action = '/divergencia/' + rdId;
      divergenciaModal.style.display = 'block';
    });
  });
  closeDivergenciaModal.addEventListener('click', () => {
    divergenciaModal.style.display = 'none';
  });
</script>

<footer>
  Desenvolvido Por André Ferreira
</footer>
</body>
</html>
